##################################################################################################
#
#	PacFIN Data Exploration for Copper Rockfish
# 		
#		Written by Chantel Wetzel
#
##################################################################################################

devtools::load_all("C:/Users/Chantel.Wetzel/Documents/GitHub/PacFIN.Utilities")
#library(PacFIN.Utilities)
devtools::load_all("C:/Users/Chantel.Wetzel/Documents/GitHub/HandyCode")
devtools::load_all("C:/Users/Chantel.Wetzel/Documents/GitHub/dataModerate_2021")
library(ggplot2)
options(stringsAsFactors = TRUE)


dir = "N://Assessments/CurrentAssessments/DataModerate_2021/copper_rockfish/data/"
setwd(dir)

load(file.path(getwd(), "commercial_comps", "PacFIN.COPP.bds.21.Feb.2021.RData"))
pacfin = bds.pacfin
bds.file = "PacFIN.COPP.bds.21.Feb.2021"
#load(file.path(getwd(), "commercial_comps", "PacFIN.COPP.bds.13.Aug.2020.RData
#load(file.path(getwd(), "commercial_comps", "PacFIN.COPP.bds.16.Oct.2020.RData"))
#pacfin = out
# Hand remove puget sound records - this needs to be added to the cleanPacFIN function
#remove = which(pacfin$PSMFC_CATCH_AREA_CODE %in% c("4A", "_PS"))
#pacfin = pacfin[-remove, ]
#pacfin_convert = cleanColumns(data = pacfin, use = 'vdrfd')
## Add some required columns for cleanPacFIN function
#pacfin_convert$INPFC_AREA = 'all'

# Load in the current weight-at-length estimates by sex
fa = 9.56e-6; fb = 3.19 
ma   = 1.08e-5; mb = 3.15    
ua  = (fa + ma)/2;  ub = (fb + mb)/2        

catch.file = read.csv(file.path(getwd(), "catches", "commercial_catch_by_state.csv"))
catch.file = catch.file[,-1]
colnames(catch.file) = c("Year", "SOUTH.ALL", "NORTH.ALL", "OR.ALL", "WA.ALL")

pacfin$age1 <- NA
Pdata = cleanPacFIN(Pdata = pacfin, 
					CLEAN = TRUE,
					verbose = TRUE)

#  Removal Report
#  
#  Records in input:                  8798 
#  Records not in USINPFC             0 
#  Records not in INPFC_AREA:         351 
#  Records in bad INPFC_AREA:         0 
#  Records in badRecords list:        0 
#  Records with bad SAMPLE_TYPE       0 
#  Records with bad SAMPLE_METHOD     0 
#  Records with no SAMPLE_NO          0 
#  Records with no usable length      225 
#  Records remaining:                 8222 


############################################################################################################
# Create areas based on areas being modeled
##########################################################################################################

south_ca = c("DNA","HNM","LGB","NWB","OBV","OLA","OSD","OXN","SB","SD","SP","TRM","VEN","WLM")
or = c("AST","BDN","BRK","DPO","FLR","GLD","NEW","ORF","PCC","SRV","TLL","WIN","COS")
north_ca = c("ALB","ALM","ARE","AVL", "BCR","BDG","BKL","BOL","BRG","CRS","CRZ","ERK",
			 "FLN","MNT","MOS","MRO","OAK","OCA","OCM","OCN","ODN","OHB","OMD","OSF","OSL","OSM","OWC","PRN","RCH","RYS","SF","SLT","TML","TRN")
wa = unique(Pdata$PCID)[!(unique(Pdata$PCID)) %in% c(south_ca, north_ca, or)]

area_grouping = list(south_ca, north_ca, or, wa)
area_names = c("SOUTH", "NORTH", "OR", "WA")
Pdata$state_areas <- NA
for (a in 1:length(area_grouping)){
	get <- paste(area_grouping[[a]], collapse = "|")
	find = grep(get, Pdata$PCID, ignore.case = TRUE)
	Pdata$state_areas[find] = area_names[a]
}


############################################################################################################
# Investigate data and create needed columns
##########################################################################################################
aggregate(lengthcm~state_areas, data = Pdata, FUN = quantile)
# state_areas lengthcm.0% lengthcm.25% lengthcm.50% lengthcm.75% lengthcm.100%
#       NORTH        18.0         32.0         38.0         44.0          61.0
#          OR        26.0         38.0         43.0         47.0          60.0
#       SOUTH        19.0         33.0         36.0         40.0          54.0
#          WA        37.0         41.5         44.0         49.5          55.0


MasterPdata = Pdata
Pdata$fleet = Pdata$state_areas
Pdata$stratification = paste(Pdata$fleet, "ALL", sep=".")

#################################################################################
# Length comp expansions
#################################################################################


Pdata_exp <- getExpansion_1(Pdata = Pdata,
					   fa = fa, fb = fb, ma = ma, mb = mb, ua = ua, ub = ub)

Pdata_exp <- getExpansion_2(Pdata = Pdata_exp, 
					   Catch = catch.file, 
					   Units = "MT",
					   maxExp = 0.80)

Pdata_exp$Final_Sample_Size <- capValues(Pdata_exp$Expansion_Factor_1_L * Pdata_exp$Expansion_Factor_2, maxVal = 0.80)

# Look for consistency between lengths and ages of sampled fish
myLbins = c(seq(10, 54, 2))

# There are very few sexed fish in CA - set them all to unsexed for simplicity
find = which(Pdata_exp$fleet %in% c("NORTH", "SOUTH"))
Pdata_exp[find, "SEX"] = "U"
Lcomps = getComps(Pdata_exp, 
				  Comps = "LEN")

writeComps(inComps = Lcomps, 
		   fname = file.path(getwd(), "commercial_comps", "forSS", paste0("Lcomps.", bds.file, ".csv")), 
		   lbins = myLbins, 
		   partition = 0, 
		   sum1 = TRUE,
		   digits = 4)

##############################################################################################################
# Format and rewrite
##############################################################################################################

# The available sex by state really vary:
#           F    M    U
#  NORTH   57   69 4200
#  OR     653  619    4
#  SOUTH    2    7 2602
#  WA       2    4    0

#########################################################################################
# For California North & South use the sexes combined in the model
#########################################################################################
out = read.csv(file.path(getwd(), "commercial_comps", "forSS", paste0("Lcomps.", bds.file, ".csv")), skip = 3, header = TRUE)
start = which(as.character(out[,1]) %in% c(" Usexed only ")) + 2
end   = nrow(out)
cut_out = out[start:end,]

ind = which(colnames(cut_out) %in% "L10"):which(colnames(cut_out) %in% "L54.1")
format = cbind(cut_out$fishyr, cut_out$month, cut_out$fleet, cut_out$sex, cut_out$partition, 
			   cut_out$Ntows, cut_out$Nsamps, cut_out$InputN, cut_out[,ind])
colnames(format) = c("fishyr", "month", "fleet", "sex", "part", "Ntows", "Nsamps", "InputN", colnames(cut_out[ind]))
format = format[format$fishyr != 2021, ]

south_comps = format[format$fleet == "SOUTH", ]
north_comps = format[format$fleet == "NORTH", ]
write.csv(south_comps, file = paste0(getwd(), "/commercial_comps/forSS/S_CA_Lcomps_unsexed_10_54_formatted_Feb21.csv"), row.names = FALSE)
write.csv(north_comps, file = paste0(getwd(), "/commercial_comps/forSS/N_CA_Lcomps_unsexed_10_54_formatted_Feb21.csv"), row.names = FALSE)

#########################################################################################
# Grabbed the females then males for Oregon & Washington
#########################################################################################
out = read.csv(file.path(getwd(), "commercial_comps", "forSS", paste0("Lcomps.", bds.file, ".csv")), skip = 3, header = TRUE)
start = 1 #which(as.character(out[,1]) %in% c(" Females then males ")) + 2 
end = which(as.character(out[,1]) %in% c(" Females only ")) - 1 #nrow(out)
cut_out = out[start:end,]

ind = which(colnames(cut_out) %in% "L10"):which(colnames(cut_out) %in% "L54.1")
format = cbind(cut_out$fishyr, cut_out$month, cut_out$fleet, cut_out$sex, cut_out$partition, 
			   cut_out$Ntows, cut_out$Nsamps, cut_out$InputN, cut_out[,ind])
colnames(format) = c("fishyr", "month", "fleet", "sex", "part", "Ntows", "Nsamps", "InputN", colnames(cut_out[ind]))
format = format[format$fishyr != 2021, ]

or = format[format$fleet == "OR", ]
wa = format[format$fleet == "WA", ]
write.csv(or, file = paste0(getwd(), "/commercial_comps/forSS/OR_Lcomps_sexed_10_54_formatted_Feb21.csv"), row.names = FALSE)
write.csv(wa, file = paste0(getwd(), "/commercial_comps/forSS/WA_Lcomps_sexed_10_54_formatted_Feb21.csv"), row.names = FALSE)


#########################################################################################
# Calculate the number of trips and fish
#########################################################################################
Pdata = Pdata_exp
temp = Pdata[!is.na(Pdata$lengthcm) & Pdata$SAMPLE_YEAR < 2021,]

Nfish = table(temp$SAMPLE_YEAR, temp$SEX, temp$fleet)

aa = unique(temp$fleet)
yy = sort(unique(temp$SAMPLE_YEAR))
Ntows = matrix(0, length(yy), length(aa))
for(y in 1:length(yy)){
	for(a in 1:length(aa)){
		ind = which(temp$SAMPLE_YEAR == yy[y] & temp$fleet == aa[a])
		if(length(ind) > 0) {Ntows[y, a] = length(unique(temp$SAMPLE_NO[ind])) }
	}
}
colnames(Ntows) = aa
rownames(Ntows) = yy

keep = Ntows[,"WA"] != 0
wa_samps = cbind(rownames(Ntows)[keep], Ntows[keep,"WA"], Nfish[keep,,"WA"])
keep = Ntows[,"OR"] != 0
or_samps = cbind(rownames(Ntows)[keep], Ntows[keep,"OR"], Nfish[keep,,"OR"])
keep = Ntows[,"NORTH"] != 0
north_ca_samps = cbind(rownames(Ntows)[keep], Ntows[keep,"NORTH"], Nfish[keep,,"NORTH"])
keep = Ntows[,"SOUTH"] != 0
south_ca_samps = cbind(rownames(Ntows)[keep], Ntows[keep,"SOUTH"], Nfish[keep,,"SOUTH"])

colnames(wa_samps) = colnames(or_samps) = colnames(north_ca_samps) = colnames(south_ca_samps) = 
	c("Year", "N_Trips", "N_Fish_Females", "N_Fish_Males", "N_Fish_Unsexed")


write.csv(wa_samps, file = paste0(getwd(), "/commercial_comps/forSS/WA_Samples.csv"), row.names = FALSE)
write.csv(or_samps, file = paste0(getwd(), "/commercial_comps/forSS/OR_Samples.csv"), row.names = FALSE)
write.csv(north_ca_samps, file = paste0(getwd(), "/commercial_comps/forSS/CA_N_Samples.csv"), row.names = FALSE)
write.csv(south_ca_samps, file = paste0(getwd(), "/commercial_comps/forSS/CA_S_Samples.csv"), row.names = FALSE)

